<!DOCTYPE html>
<html>
<head>
  <title>JGC Youth Service Group Mapping</title>
  <%= stylesheet_link_tag :all %>
  <%= javascript_include_tag :defaults %>
  <%= csrf_meta_tag %>

  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <!--get user location-->
  <% @loc = Zip.find_by_code(@user_zipcode) %>
  <% @loc = Zip.find_by_code(94303) unless @loc %>
  <!--end user locale-->

  <script type="text/javascript">

    var directionDisplay;
    var directionsService = new google.maps.DirectionsService();
    var map;
    var geocoder = null;
    var trafficInfo = null;
    var trafficStatus = 1;

    function initialize() {
      directionsDisplay = new google.maps.DirectionsRenderer();
      var location_to_show = new google.maps.LatLng(<%= @loc.lat %>, -<%= @loc.lon %>);
      var myOptions = {
        zoom:13,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: location_to_show
      }
      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
      directionsDisplay.setMap(map);
      directionsDisplay.setPanel(document.getElementById("directionsPanel"));



        geocoder = new google.maps.Geocoder();
        trafficInfo = new google.maps.TrafficLayer();
        trafficInfo.setMap(map);
    }

    function showOnMap(lat,lon,name)
    {
      var program_location = new google.maps.LatLng(lat,lon);
      var marker = new google.maps.Marker({
        position: program_location,
        map: map,
        title: name
      });
      
      var contentString = "<div class='popUp'><span class='popUpTop'>" + name + "</span><br />" + "JBB was here</div>";
      var infowindow = new google.maps.InfoWindow({
        content: contentString
      });

      google.maps.event.addListener(marker, 'click', function() {
        //map.setZoom(8);
        infowindow.open(map,marker);
      });
    }


    function drawPrograms()
    {
      <% unless @nearbyPrograms.nil? %>
        <% for program in @nearbyPrograms %>
          showOnMap(<%= program.lat %>, <%= program.lon %>,"<%= program.name %>");
        <% end %>
      <% end %>
    }


    function toggleTraffic() {
      if (trafficStatus == 1) {
        trafficInfo.setMap(null);
        trafficStatus = 0;
      } else {
        trafficInfo.setMap(map);
        trafficStatus = 1;
      }
    }


  
    function calcRoute(fromAddress, toAddress) {
      var start = "San Francisco";
      var end = "Los Angeles";
      var request = {
          origin:fromAddress, 
          destination:toAddress,
          travelMode: google.maps.DirectionsTravelMode.DRIVING
      };
      directionsService.route(request, function(response, status) {
        if (status == google.maps.DirectionsStatus.OK) {
          directionsDisplay.setDirections(response);
        }
      });
    }

    </script>


</head>
<body onload="initialize(); drawPrograms()">

<div id="nav">
  <ul>
    <li id="home">Youth programs in zip code: <%= @user_zipcode %></li>
  </ul>
</div>	

<% if flash[:notice] -%>
  <div id="error_explanation">
    <%= flash[:notice] %>
  </div>
<% end %>

<%= yield %>

<div id="footer">
  <ul>
    <li>This Web application is developed and maintained by the <a href="http://jgc.stanford.edu/">John Gardner Center</a> at Stanford University</li>
  </ul>
  <div id="copyright" class="vcard">
  &copy; <span class="fn org">John Gardner Center</span>.  All Rights Reserved.  <span class="adr"><span class="locality">Stanford</span>, <span class="region">CA</span>  <span class="postal-code">94305</span></span>. <span class="tel">(650) 723-1137</span>.  <a href="http://www.stanford.edu/home/atoz/terms.html">Terms of Use</a>
  </div>
</div>

</body>
</html>
