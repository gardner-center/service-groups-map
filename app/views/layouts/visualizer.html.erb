<!DOCTYPE html>
<html>
<head>
  <title>JGC Youth Service Group Mapping</title>
  <%= stylesheet_link_tag :all %>
  <%= javascript_include_tag :defaults %>
  <%= csrf_meta_tag %>

  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>

  <script type="text/javascript">

    var directionDisplay;
    var directionsService = new google.maps.DirectionsService();
    var map;
    var markersArray = [];
    var infoWindowArray = [];


    function initialize() {
      directionsDisplay = new google.maps.DirectionsRenderer();
      var location_to_show = new google.maps.LatLng(<%= @user_lat %>, <%= @user_lon %>);
      var myOptions = {
        zoom:13,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: location_to_show
      }
      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
      directionsDisplay.setMap(map);
      directionsDisplay.setPanel(document.getElementById("directionsPanel"));
    }

    function drawNewMap(lat,lon) {
      //remove old map
      document.getElementById("map_canvas").replace("<div id='map_canvas' style='width: 100%; height: 400px'></div>");
      document.getElementById("directionsPanel").replace("<div id='directionsPanel' style='width: 100%; height:100%;'><span id='directionNotes'></span></div>");
      //build new one
      directionsDisplay = new google.maps.DirectionsRenderer();
      var location_to_show = new google.maps.LatLng(lat,lon);
      var myOptions = {
        zoom:13,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        center: location_to_show
      }
      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
      directionsDisplay.setMap(map);
      directionsDisplay.setPanel(document.getElementById("directionsPanel"));
    }

    function showOnMap(lat,lon,name,details,detailsPhone,detailsURL)
    {
      var program_location = new google.maps.LatLng(lat,lon);
      var marker = new google.maps.Marker({
        position: program_location,
        map: map,
        title: name
      });
      markersArray.push(marker);
      
      var contentString = "<div class='popUp'><span class='popUpTop'>" + name + "</span><br />" + details + "<br />" + 
                           detailsPhone + "<br />" + detailsURL + "</div>";
      var infowindow = new google.maps.InfoWindow({
        content: contentString,
        maxWidth: 350
      });
      infoWindowArray.push(infowindow);

      google.maps.event.addListener(marker, 'click', function() {
        //map.setZoom(8);
        for (var i=0;i < infoWindowArray.length; i++) {
          infoWindowArray[i].close(map.marker);
        }
        infowindow.open(map,marker);
      });
    }

    function drawPrograms()
    {
      <% unless @nearbyPrograms.nil? %>
        <% for program in @nearbyPrograms %>
          <% details = "#{program.formatted_address}" 
           detailsPhone = "#{program.phone}" 
           detailsURL = "#{program.website}" %>
          showOnMap(<%= program.lat %>, <%= program.lon %>,"<%= program.name %>","<%= details %>","<%= detailsPhone %>","<%= detailsURL %>");
        <% end %>
      <% end %>
    }

    function deleteOverlays()
    {
      if (infoWindowArray) {
        infoWindowArray.length = 0;
      }
      if (markersArray) {
        for (var i=0;i < markersArray.length; i++) {
          markersArray[i].setMap(null);
        }
        markersArray.length = 0;
      }
    }

    </script>


</head>
<body onload="initialize(); drawPrograms()">

<div id="nav">
  <ul>
    <li id="home">Youth programs near: <span id="center_point"><%= @user_zipcode %></span></li>
  </ul>
</div>	

<% if flash[:notice] -%>
  <div id="error_explanation">
    <%= flash[:notice] %>
  </div>
<% end %>

<%= yield %>

<div id="footer">
  <ul>
    <li>This Web application is developed and maintained by the <a href="http://jgc.stanford.edu/">John Gardner Center</a> at Stanford University</li>
  </ul>
  <div id="copyright" class="vcard">
  &copy; <span class="fn org">John Gardner Center</span>.  All Rights Reserved.  <span class="adr"><span class="locality">Stanford</span>, <span class="region">CA</span>  <span class="postal-code">94305</span></span>. <span class="tel">(650) 723-1137</span>.  <a href="http://www.stanford.edu/home/atoz/terms.html">Terms of Use</a>
  </div>
</div>

</body>
</html>
