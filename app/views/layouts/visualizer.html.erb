<!DOCTYPE html>
<html>
<head>
  <title>JGC Youth Service Group Mapping</title>
  <%= stylesheet_link_tag :all %>
  <%= javascript_include_tag :defaults %>
  <%= csrf_meta_tag %>

  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <!--get user location-->
  <% @loc = Zip.find_by_code(@user_zipcode) %>
  <% @loc = Zip.find_by_code(94303) unless @loc %>
  <!--end user locale-->

  <script type="text/javascript">

	var directionDisplay;
        var directionsService = new google.maps.DirectionsService();
        var map;
	var geocoder = null;
	var trafficInfo = null;
	var trafficStatus = 1;

		function initialize() {
		  directionsDisplay = new google.maps.DirectionsRenderer();
		  var location_to_show = new google.maps.LatLng(<%= @loc.lat %>, -<%= @loc.lon %>);
		  var myOptions = {
		    zoom:13,
		    mapTypeId: google.maps.MapTypeId.ROADMAP,
		    center: location_to_show
		  }
		  map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		  directionsDisplay.setMap(map);
		  directionsDisplay.setPanel(document.getElementById("directionsPanel"));

	          geocoder = new google.maps.Geocoder();
		  trafficInfo = new google.maps.TrafficLayer();
		  trafficInfo.setMap(map);
		}

    function toggleTraffic() {
      if (traffic_status == 1) {
        trafficInfo.setMap(null);
        traffic_status = 0;
      } else {
        trafficInfo.setMap(map);
        traffic_status = 1;
      }
    }

		function drawNearbyPrograms()
		{
			<% unless @nearbyPrograms.nil? %>
                          <%for program in @nearbyPrograms%>
				showAddress("<%=program.address1=%> " + "<%=program.city=%> " + "<%=program.state=%> " + "<%=program.zipcode=%>");
			  <%end%>
                        <% end %>
		}

		function showAddress(address)
		{
	    if (geocoder) 
			{
	      geocoder.geocode( { 'address': address}, addToMap );
	    }
		}

		function addToMap(results, status)
    {
      if(status == google.maps.GeocoderStatus.OK)
      {
        map.setCenter(results[0].geometry.location);
        var marker = new google.maps.Marker( {map: map, position: results[0].geometry.location} );
				var description = '<form method="get" action="http://www.google.com/search"> <div style="border:1px solid black;padding:4px;width:20em;"> <table border="0" cellpadding="0"> <tr><td> <input type="text"   name="q" size="25" maxlength="255" value="" /> <input type="submit" value="Google Search" /></td></tr> <tr><td align="center" style="font-size:75%"> <input type="checkbox" name="sitesearch" value="stanford.edu" checked /> only search Stanford.edu<br /> </td></tr></table> </div> </form>';
				var infowindow = new google.maps.InfoWindow( {content: description} );
				google.maps.event.addListener(marker, 'click', function () {
					//infowindow.setContent(this.html);
					infowindow.open(map, marker);
				});
      }
      else
      {
        alert("Geocode was not successful for the following reason: " + status);
      }
    }
  
		function calcRoute(fromAddress, toAddress) {
		  var start = "San Francisco";
		  var end = "Los Angeles";
		  var request = {
		      origin:fromAddress, 
		      destination:toAddress,
		      travelMode: google.maps.DirectionsTravelMode.DRIVING
		  };
		  directionsService.route(request, function(response, status) {
		    if (status == google.maps.DirectionsStatus.OK) {
		      directionsDisplay.setDirections(response);
		    }
		  });
		}

    </script>


</head>
<body onload="initialize()" onunload="GUnload()">

<div id="nav">
  <ul>
    <li id="home">Youth programs in zip code: <%= @user_zipcode %></li>
  </ul>
</div>	

<% if flash[:notice] -%>
  <div id="error_explanation">
    <%= flash[:notice] %>
  </div>
<% end %>

<%= yield %>

<div id="footer">
  <ul>
    <li>This Web application is developed and maintained by the <a href="http://jgc.stanford.edu/">John Gardner Center</a> at Stanford University</li>
  </ul>
  <div id="copyright" class="vcard">
  &copy; <span class="fn org">John Gardner Center</span>.  All Rights Reserved.  <span class="adr"><span class="locality">Stanford</span>, <span class="region">CA</span>  <span class="postal-code">94305</span></span>. <span class="tel">(650) 723-1137</span>.  <a href="http://www.stanford.edu/home/atoz/terms.html">Terms of Use</a>
  </div>
</div>

</body>
</html>
